name: Publish to PyPI and MCP Registry

on:
  push:
    tags:
      - 'v*'

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            cibw_build: "*-manylinux_x86_64"
          - os: windows-latest
            cibw_build: "*-win_amd64"
          - os: macos-latest
            cibw_build: "*-macosx_x86_64 *-macosx_arm64"

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'

      - name: Download Stockfish
        run: |
          mkdir -p stockfish_mcp/bin
          if [ "$RUNNER_OS" == "Linux" ]; then
            curl -L "https://github.com/official-stockfish/Stockfish/releases/latest/download/stockfish-ubuntu-x86-64-avx2.tar" | tar -x -C stockfish_mcp/bin --strip-components=1
          elif [ "$RUNNER_OS" == "Windows" ]; then
            curl -L "https://github.com/official-stockfish/Stockfish/releases/latest/download/stockfish-windows-x86-64-avx2.zip" -o stockfish.zip
            unzip stockfish.zip -d stockfish_mcp/bin
          elif [ "$RUNNER_OS" == "macOS" ]; then
            curl -L "https://github.com/official-stockfish/Stockfish/releases/latest/download/stockfish-macos-x86-64.tar" | tar -x -C stockfish_mcp/bin --strip-components=1
          fi
        shell: bash

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.16.2
        env:
          CIBW_BUILD: ${{ matrix.cibw_build }}

      - name: Store wheel
        uses: actions/upload-artifact@v4
        with:
          path: ./wheelhouse/*.whl

  publish:
    name: Publish to PyPI and MCP Registry
    needs: build_wheels
    runs-on: ubuntu-latest
    permissions:
      id-token: write

    steps:
      - uses: actions/checkout@v3

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}

      - name: Install MCP Publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xz mcp-publisher

      - name: Login to MCP Registry
        run: ./mcp-publisher login github-oidc

      - name: Update server.json with version
        run: sed -i "s/__VERSION__/${{ github.ref_name }}/g" server.json

      - name: Publish to MCP Registry
        run: ./mcp-publisher publish